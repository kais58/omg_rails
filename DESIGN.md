# Overview
Models in the OMG Rails app fall in one of five categories:

### KEY Permanent, not ruleset specific
These models are important keystone models that are essential and are not expected to change. Records in 
these models should exist for the duration of the app's existence.

_**Feature changes for a patch should result in new records, not modifications of existing records (except in case of a fix).**_
* For example, if a doctrine's unlock tree is reworked for a patch, new unlocks should be created for the updated doctrine unlocks. This allows snapshot companies from old rulesets to continue linking to their old doctrine unlocks

### Permanent, not ruleset specific, associated with KEY models
These models provide additional functionality on top of KEY models that is also not expected to change. 

_**Feature changes for a patch should result in new records, not modifications of existing records (except in case of a fix).**_

### Temporary per ruleset, user and stats facing
These models expect to be cleared of data during a war reset and aren't required for company snapshots, but records should still only exist for the duration of
the ruleset. 

### Temporary per ruleset, must be recreated per patch/ruleset version
These models are necessary to construct companies, and could be modified by feature changes in a patch. To provide a historical record for
previous ruleset versions these models expect to be copied for the new active ruleset.

### Temporary per ruleset, associated with ruleset-based models, necessary for company snapshots
These models are also expected to be cleared of data during a war reset, but they are necessary for company snapshots.


## Entity Relation Diagram
<img src="OMG Rails Data Model.png">

# Specific Model Notes

## Company Unlocks

To support unit swapping, we need to change squads' `available_unit` attribute to point to the new `available_unit` for the new unit. 
This requires differentiating `AvailableUnit` by type so that we only use `BaseAvailableUnit`, representing the primary purchasable
version of the unit (as opposed to free or other special cases), to swap to.

Since now it's possible to have multiple `AvailableUnits` for a `Company` and `Unit`, company squad updates need to pass 
`available_unit_id` as the identifier of what was purchased as `unit_id` will not be sufficiently specific.

## Unit Modifications
There are certain subclasses of `RestrictionUnit` that when unlocked by a company unlock purchase, will be applied against the `BaseAvailableUnit` of the associated unit.

The fields affected are enumerated in `RestrictionUnit::MODIFY_FIELDS`.

The priority of the record will determine where in the order it is applied, from 1 to 100, with 1 applied first and 100 last.

Cases:
* `ModifiedReplaceUnit` - any non-nil fields on this record will replace that of the `BaseAvailableUnit`
* `ModifiedAddUnit` - any non-nil fields on this record will be added to that of the `BaseAvailableUnit`. The value can be negative.

## Transport
1. New model `TransportAllowedUnit` represents one to many of transport units to units they are permitted to transport
2. New model `TransportedSquad` represents a specific relationship between a transport `Squad` and an embarked `Squad`. Currently this should be 1 level of transport only.
3. `Units` capable of transport have two fields for their capacities: `transport_squad_slots` and `transport_model_slots`. Squads of these units must keep their embarked squads at or below those squad and model limits.
4. `Units` capable of being embarked have a new field `model_count` representing how many model slots the unit takes up
5. Squads have a new field `total_model_count` representing the total model slots it takes up, including upgrades.
6. Squads have a new field `uuid` of a unique string id generated by the front end. This is used to identify transport relationships between squads when they exist only in the FE and haven't been persisted (given an id by the db). Since this is the only reliable id we have in the FE for new squads we use `uuid` for all transport related operations.

## Offmaps 
Follow the Unit model, where

* `offmap` describes the base offmap entity with no cost. Associated with `Ruleset` to allow tracking changes across rulesets 
* `restriction_offmap` describes how a base `offmap` is made available to different restrictions. Costs included
* `available_offmap` describes what `offmaps` are available to a company, established from `restriction_offmap`

## Callin Modifiers
`CallinModifier` defines the modifier value, and how the modifier is applied (currently multiplicative only)

`CallinModifierRequiredUnit` defines certain units that the platoon must have one of in order to qualify for the callin modifier
* If none exist for the `CallinModifier`, signals that any mix of the allowed units are valid

`CallinModifierAllowedUnit` defines all units that may be in the platoon and still qualify for the callin modifier. 
* If there are non-zero `CallinModifierAllowedUnit`s, only those units may exist in the platoon and qualify
* If there are zero `CallinModifierAllowedUnit`s, any unit may exist in the platoon and qualify

## Squad Upgrades
1. `Squad` model has a `pop` attribute encompassing both the unit's pop and any squad upgrades with pop
2. UI will update this pop value for the user's convenience during company construction, but the backend will recalculate the squad pop value before saving